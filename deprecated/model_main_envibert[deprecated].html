<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="This notebook contains some example of how to use the EnviBert-based models in this NLP library">

<title>that-nlp-library - Model Controller Tutorial: EnviBert model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="that-nlp-library - Model Controller Tutorial: EnviBert model">
<meta property="og:description" content="This notebook contains some example of how to use the EnviBert-based models in this NLP library">
<meta property="og:site_name" content="that-nlp-library">
<meta name="twitter:title" content="that-nlp-library - Model Controller Tutorial: EnviBert model">
<meta name="twitter:description" content="This notebook contains some example of how to use the EnviBert-based models in this NLP library">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">that-nlp-library</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Model Controller Tutorial: EnviBert model</li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to that-nlp-library</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">1. Quick Starts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Main</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_classification_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Controller Tutorial: Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_lm_roberta_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Controller Tutorial: Training a Roberta Language Model</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">2. All Use Cases</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">a. Roberta-based models for Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_singlehead.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model (Custom Single Head)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_multihead.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model (Multi Head)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_multihead_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model (Regression)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_conditional_prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model with Conditional Probability</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_dhc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model with Deep Hierarchical Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_multilabel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model (Multi-Label)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">b. GPT2-based models for Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gpt2_singlehead.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT2 model (Custom Single Head)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gpt2_multihead.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT2 model (Multi Head)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gpt2_multihead_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT2 model (Regression)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">c.&nbsp;Masked Language Model Training</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_lm_roberta_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Controller Tutorial: Training a Roberta Language Model</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">d.&nbsp;Causal Language Model Training</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_lm_gpt2_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Controller Tutorial: Training a GPT2 Language Model</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">e. Training A Streamed Dataset</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_singlehead_for_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta model with a streamed dataset (Custom Single Head)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../roberta_lm_for_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta Language Model for a streamed dataset</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">3. Evaluations For Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../evaluations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Evaluations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">4. Hidden States Extraction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../hidden_states.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Feature Extraction From Hidden States</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
 <span class="menu-text">5. Text Classes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false">
 <span class="menu-text">a. Text Processing</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_augmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Augmentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_transformation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Transformation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false">
 <span class="menu-text">b. Text Controller For Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Main</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Main Streaming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main_benchmark.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Processing Benchmark</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false">
 <span class="menu-text">c.&nbsp;Text Controller For Language Modeling</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main_lm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Main For Language Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../text_main_lm_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Text Main For Language Model - Streaming</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" aria-expanded="true">
 <span class="menu-text">6. Model Classes</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" aria-expanded="false">
 <span class="menu-text">a. Model Controller For Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_main.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Model Main Functions and Controller</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" aria-expanded="false">
 <span class="menu-text">b. Model Controller for Language Modeling</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../model_lm_main.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Language Model Main Functions and Controller</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" aria-expanded="false">
 <span class="menu-text">c.&nbsp;Roberta-based classification Model</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-17" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.roberta.classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roberta Classifiers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.roberta.deep_hierarchical_classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Deep Hierarchical Classifiers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.roberta.conditional_prob_classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditional Probability Classifiers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" aria-expanded="false">
 <span class="menu-text">d.&nbsp;GPT2-based classification Model</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-18" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models.gpt2.classifiers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPT2 Classifiers</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" aria-expanded="true">
 <span class="menu-text">7. Utility</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-19" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utils</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-data" id="toc-load-data" class="nav-link active" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#model-experiment-envibert-single-head-classification" id="toc-model-experiment-envibert-single-head-classification" class="nav-link" data-scroll-target="#model-experiment-envibert-single-head-classification">Model Experiment: EnviBert Single-Head Classification</a>
  <ul class="collapse">
  <li><a href="#train-envibert-using-tdm" id="toc-train-envibert-using-tdm" class="nav-link" data-scroll-target="#train-envibert-using-tdm">Train EnviBert using TDM</a>
  <ul class="collapse">
  <li><a href="#logging-your-training" id="toc-logging-your-training" class="nav-link" data-scroll-target="#logging-your-training">Logging your training</a></li>
  </ul></li>
  <li><a href="#train-envibert-with-tokenized-datasetdict" id="toc-train-envibert-with-tokenized-datasetdict" class="nav-link" data-scroll-target="#train-envibert-with-tokenized-datasetdict">Train EnviBert with tokenized DatasetDict</a></li>
  <li><a href="#predict-using-trained-model-using-tdm" id="toc-predict-using-trained-model-using-tdm" class="nav-link" data-scroll-target="#predict-using-trained-model-using-tdm">Predict using trained model, using TDM</a>
  <ul class="collapse">
  <li><a href="#load-trained-model" id="toc-load-trained-model" class="nav-link" data-scroll-target="#load-trained-model">Load trained model</a></li>
  <li><a href="#predict-trainvalidation-set" id="toc-predict-trainvalidation-set" class="nav-link" data-scroll-target="#predict-trainvalidation-set">Predict Train/Validation set</a></li>
  <li><a href="#predict-test-set" id="toc-predict-test-set" class="nav-link" data-scroll-target="#predict-test-set">Predict Test set</a></li>
  </ul></li>
  <li><a href="#predict-using-trained-model-using-tokenized-datasetdict" id="toc-predict-using-trained-model-using-tokenized-datasetdict" class="nav-link" data-scroll-target="#predict-using-trained-model-using-tokenized-datasetdict">Predict using trained model, using tokenized DatasetDict</a>
  <ul class="collapse">
  <li><a href="#load-trained-model-1" id="toc-load-trained-model-1" class="nav-link" data-scroll-target="#load-trained-model-1">Load trained model</a></li>
  <li><a href="#predict-validation-set" id="toc-predict-validation-set" class="nav-link" data-scroll-target="#predict-validation-set">Predict validation set</a></li>
  <li><a href="#predict-test-set-1" id="toc-predict-test-set-1" class="nav-link" data-scroll-target="#predict-test-set-1">Predict test set</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/anhquan0412/that-nlp-library/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Model Controller Tutorial: EnviBert model</h1>
</div>

<div>
  <div class="description">
    This notebook contains some example of how to use the EnviBert-based models in this NLP library
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="load-data" class="level1">
<h1>Load data</h1>
<p>We will reuse the sample data in <a href="https://anhquan0412.github.io/that-nlp-library/text_main.html">this tutorial</a> to experiment with the models</p>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> that_nlp_library.text_transformation <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> that_nlp_library.text_augmentation <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> that_nlp_library.text_main <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> underthesea <span class="im">import</span> text_normalize</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> importlib.machinery <span class="im">import</span> SourceFileLoader</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> DataCollatorWithPadding</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define some necessary text augmentations and text transformations</p>
<blockquote class="blockquote">
<p>For Text Transformation</p>
</blockquote>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>txt_tfms<span class="op">=</span>[text_normalize]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>For Text Augmentation</p>
</blockquote>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>over_nonown_tfm <span class="op">=</span> partial(sampling_with_condition,query<span class="op">=</span><span class="st">'Source=="non owned"'</span>,frac<span class="op">=</span><span class="fl">0.5</span>,seed<span class="op">=</span><span class="dv">42</span>,apply_to_all<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>over_nonown_tfm.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'Oversampling Non Owned'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>over_own_tfm <span class="op">=</span> partial(sampling_with_condition,query<span class="op">=</span><span class="st">'Source=="owned"'</span>,frac<span class="op">=</span><span class="dv">2</span>,seed<span class="op">=</span><span class="dv">42</span>,apply_to_all<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>over_own_tfm.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'Oversampling Owned'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>over_hc_tfm <span class="op">=</span> partial(sampling_with_condition,query<span class="op">=</span><span class="st">'Source=="hc search"'</span>,frac<span class="op">=</span><span class="fl">2.5</span>,seed<span class="op">=</span><span class="dv">42</span>,apply_to_all<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>over_hc_tfm.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'Oversampling HC search'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>remove_accent_tfm <span class="op">=</span> partial(remove_vnmese_accent,frac<span class="op">=</span><span class="dv">1</span>,seed<span class="op">=</span><span class="dv">42</span>,apply_to_all<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>remove_accent_tfm.<span class="va">__name__</span> <span class="op">=</span> <span class="st">'Add No-Accent Text'</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>aug_tfms <span class="op">=</span> [over_nonown_tfm,over_own_tfm,over_hc_tfm,remove_accent_tfm]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a TextDataMain object</p>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>DATA_PATH <span class="op">=</span> Path(<span class="st">'sample_data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tdm <span class="op">=</span> TextDataMain.from_csv(DATA_PATH<span class="op">/</span><span class="st">'sample_large.csv'</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                            return_df<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                            main_content<span class="op">=</span><span class="st">'Content'</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                            metadatas<span class="op">=</span><span class="st">'Source'</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                            label_names<span class="op">=</span><span class="st">'L1'</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                            val_ratio<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                            split_cols<span class="op">=</span><span class="st">'L1'</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>                            content_tfms <span class="op">=</span> txt_tfms,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>                            aug_tfms <span class="op">=</span> aug_tfms,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                            process_metadatas<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                            seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                            shuffle_trn<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>----- Input Validation Precheck -----
DataFrame contains duplicated values!
-----&gt; Number of duplications: 16 rows</code></pre>
</div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>tdm.df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">Content</th>
<th data-quarto-table-cell-role="th">L1</th>
<th data-quarto-table-cell-role="th">L2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2264</td>
<td>Google Play</td>
<td>Đăng xuất tài khoản thì không đăng nhập lại được.</td>
<td>Shopee account</td>
<td>Sign up/Log in</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2265</td>
<td>Non Owned</td>
<td>Triển lãm Thương mại Điện tử Việt Nam với sự t...</td>
<td>Others</td>
<td>Branding</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2266</td>
<td>Google Play</td>
<td>Như cứtttttttt</td>
<td>Others</td>
<td>Cannot defined</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2267</td>
<td>HC search</td>
<td>áo khoác</td>
<td>Others</td>
<td>Cannot defined</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2268</td>
<td>Non Owned</td>
<td>[https://shopee.vn/jocastore.vn](https://shope...</td>
<td>Others</td>
<td>Cannot defined</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Define our tokenizer for EnviBert</p>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>cache_dir<span class="op">=</span>Path(<span class="st">'./envibert_tokenizer'</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> SourceFileLoader(<span class="st">"envibert.tokenizer"</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                             <span class="bu">str</span>(cache_dir<span class="op">/</span><span class="st">'envibert_tokenizer.py'</span>)).load_module().RobertaTokenizer(cache_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # EnviBert a data collator to work. We will save this as an attribute in TDM</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># data_collator = DataCollatorWithPadding(tokenizer,padding=True,max_length=512)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tdm.set_data_collator(data_collator)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create our DatasetDict from TextDataMain (as our <a href="https://anhquan0412.github.io/that-nlp-library/model_main.html#modelcontroller"><code>ModelController</code></a> class can also work with DatasetDict)</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>main_ddict<span class="op">=</span> tdm.to_datasetdict(tokenizer,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                max_length<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Start Main Text Processing --------------------
----- Metadata Simple Processing &amp; Concatenating to Main Content -----
----- Label Encoding -----
-------------------- Text Transformation --------------------
----- text_normalize -----
-------------------- Train Test Split --------------------
Previous Validation Percentage: 20.009%
- Before leak check
Size: 454
- After leak check
Size: 447
- Number of rows leaked: 7, or 1.54% of the original validation (or test) data
Current Validation Percentage: 19.7%
-------------------- Text Augmentation --------------------
Train data size before augmentation: 1822
----- Oversampling Non Owned -----
Train data size after THIS augmentation: 2020
----- Oversampling Owned -----
Train data size after THIS augmentation: 2248
----- Oversampling HC search -----
Train data size after THIS augmentation: 2390
----- Add No-Accent Text -----
Train data size after THIS augmentation: 4780
Train data size after ALL augmentation: 4780
-------------------- Map Tokenize Function --------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████| 2269/2269 [00:00&lt;00:00, 3928.47it/s]
100%|████████████████████████████████████| 2390/2390 [00:00&lt;00:00, 19058.57it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>main_ddict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 4780
    })
    validation: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 447
    })
})</code></pre>
</div>
</div>
<p>Let’s see some examples of outputs the TDM produces:</p>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>two_steps_tokenization_explain(<span class="st">'Tôi đặt hàng mà chẳng thấy giao 1 năm rồi.Làm với chả ăn,chán 🤬 🤬 🤬 🤬 🤬 🤬'</span>,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>                               tokenizer,content_tfms<span class="op">=</span>[text_normalize])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>----- Text Transformation Explained -----
--- Raw sentence ---
Tôi đặt hàng mà chẳng thấy giao 1 năm rồi.Làm với chả ăn,chán 🤬 🤬 🤬 🤬 🤬 🤬
--- text_normalize ---
Tôi đặt hàng mà chẳng thấy giao 1 năm rồi . Làm với chả ăn , chán 🤬 🤬 🤬 🤬 🤬 🤬

----- Tokenizer Explained -----
--- Input ---
Tôi đặt hàng mà chẳng thấy giao 1 năm rồi . Làm với chả ăn , chán 🤬 🤬 🤬 🤬 🤬 🤬

--- Tokenized results --- 
{'input_ids': [0, 842, 642, 114, 145, 1371, 289, 363, 139, 93, 539, 5, 3798, 39, 7225, 380, 4, 5925, 3529, 3, 3529, 3, 3529, 3, 3529, 3, 3529, 3, 3529, 3, 2], 'token_type_ids': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 'attention_mask': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]}

--- Results from tokenizer.convert_ids_to_tokens ---
['&lt;s&gt;', '▁Tôi', '▁đặt', '▁hàng', '▁mà', '▁chẳng', '▁thấy', '▁giao', '▁1', '▁năm', '▁rồi', '▁.', '▁Làm', '▁với', '▁chả', '▁ăn', '▁,', '▁chán', '▁', '&lt;unk&gt;', '▁', '&lt;unk&gt;', '▁', '&lt;unk&gt;', '▁', '&lt;unk&gt;', '▁', '&lt;unk&gt;', '▁', '&lt;unk&gt;', '&lt;/s&gt;']

--- Results from tokenizer.decode --- 
&lt;s&gt; ▁Tôi ▁đặt ▁hàng ▁mà ▁chẳng ▁thấy ▁giao ▁1 ▁năm ▁rồi ▁. ▁Làm ▁với ▁chả ▁ăn ▁, ▁chán ▁ &lt;unk&gt; ▁ &lt;unk&gt; ▁ &lt;unk&gt; ▁ &lt;unk&gt; ▁ &lt;unk&gt; ▁ &lt;unk&gt; &lt;/s&gt;
</code></pre>
</div>
</div>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tdm.tokenizer_explain_single(tokenizer) <span class="co"># Pick a random text in train set to explain</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>----- Tokenizer Explained -----
--- Input ---
owned - # ShopeePaychamguibaiSS3 # ShopeePay1111 link : https://bit.ly/UuDaiShopeePay11-11 Username : chipheo2306 Thương hiệu l’oreal rất hay chạy sale những ngày lễ lớn và nhất ngày 11.11 có thể sẽ có voucher giảm 50 % giảm tối đa 100 k nếu săn được voucher mình rất muốn sản phẩm ￼ Nước tẩy trang cho mọi loại da L'Oreal Paris 3 in1 Micellar Water 400 ml bởi sản phẩm giá thành bình dân nếu săn sale nữa thì càng rẻ cho dung tích lớn 400 ml lận và sản phẩm có chứa công nghệ mi-xen đột phá Chiết xuất thảo dược và Glycerin bổ sung độ ẩm cho da Hút tất cả bụi bẩn , cặn dơ của lớp make-up mà không gây khô da . Với công nghệ mới , mang đến các tẩy trang , làm sạch , giữ ẩm và dưỡng mềm da đồng thời chỉ trong một sản phẩm . Mình luôn ưu tiên thanh toán qua ShopeePay để thanh toán được tiện lợi và nhanh chóng

--- Tokenized results --- 
{'input_ids': [0, 3507, 13, 2481, 1888, 51603, 53097, 1501, 1509, 10976, 4020, 2327, 31682, 1245, 2481, 1888, 51603, 53097, 4894, 4894, 1599, 46, 47048, 5513, 5713, 428, 428, 12651, 244, 1142, 428, 2057, 1114, 1477, 2327, 17803, 51603, 53097, 4894, 7343, 10578, 7103, 6460, 46, 6613, 58185, 54439, 1603, 2332, 325, 1546, 3, 47666, 173, 292, 1065, 4331, 53, 125, 1204, 300, 17, 134, 125, 704, 10890, 22, 61, 75, 22, 25734, 455, 918, 213, 455, 876, 930, 825, 1817, 513, 4738, 34, 25734, 177, 173, 452, 165, 280, 3529, 3, 4460, 5540, 430, 35, 584, 342, 680, 748, 427, 2187, 21633, 2759, 186, 11, 1147, 18100, 27237, 6499, 3198, 20332, 688, 165, 280, 157, 119, 565, 191, 513, 4738, 4331, 685, 132, 840, 1617, 35, 936, 448, 300, 3198, 20332, 10166, 17, 165, 280, 22, 1880, 59, 552, 5297, 142, 1780, 883, 2198, 1167, 18729, 228, 1425, 3789, 17, 31062, 12035, 829, 1334, 1790, 276, 3075, 35, 680, 29574, 781, 206, 4199, 5749, 4, 16823, 29324, 20, 1028, 364, 142, 4281, 145, 38, 533, 2557, 680, 5, 816, 59, 552, 183, 4, 434, 62, 29, 5540, 430, 4, 83, 1610, 4, 679, 3075, 17, 1187, 1794, 680, 122, 155, 127, 37, 40, 165, 280, 5, 4910, 612, 1261, 597, 656, 1081, 204, 1888, 51603, 53097, 58, 656, 1081, 34, 957, 579, 17, 687, 1519, 2], 'token_type_ids': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 'attention_mask': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]}

--- Results from tokenizer.convert_ids_to_tokens ---
['&lt;s&gt;', '▁owned', '▁-', '▁#', '▁Sh', 'opee', 'Pay', 'ch', 'am', 'gu', 'ib', 'ai', 'SS', '3', '▁#', '▁Sh', 'opee', 'Pay', '11', '11', '▁link', '▁:', '▁htt', 'ps', ':', '/', '/', 'bit', '.', 'ly', '/', 'U', 'u', 'D', 'ai', 'Sh', 'opee', 'Pay', '11', '-11', '▁Us', 'ern', 'ame', '▁:', '▁chip', 'heo', '230', '6', '▁Thương', '▁hiệu', '▁l', '&lt;unk&gt;', 'oreal', '▁rất', '▁hay', '▁chạy', '▁sale', '▁những', '▁ngày', '▁lễ', '▁lớn', '▁và', '▁nhất', '▁ngày', '▁11', '.11', '▁có', '▁thể', '▁sẽ', '▁có', '▁voucher', '▁giảm', '▁50', '▁%', '▁giảm', '▁tối', '▁đa', '▁100', '▁k', '▁nếu', '▁săn', '▁được', '▁voucher', '▁mình', '▁rất', '▁muốn', '▁sản', '▁phẩm', '▁', '&lt;unk&gt;', '▁Nước', '▁tẩy', '▁trang', '▁cho', '▁mọi', '▁loại', '▁da', '▁L', "'", 'O', 'real', '▁Paris', '▁3', '▁in', '1', '▁Mic', 'ellar', '▁Water', '▁400', '▁ml', '▁bởi', '▁sản', '▁phẩm', '▁giá', '▁thành', '▁bình', '▁dân', '▁nếu', '▁săn', '▁sale', '▁nữa', '▁thì', '▁càng', '▁rẻ', '▁cho', '▁dung', '▁tích', '▁lớn', '▁400', '▁ml', '▁lận', '▁và', '▁sản', '▁phẩm', '▁có', '▁chứa', '▁công', '▁nghệ', '▁mi', '-', 'x', 'en', '▁đột', '▁phá', '▁Chiết', '▁xuất', '▁thảo', '▁dược', '▁và', '▁Gly', 'cer', 'in', '▁bổ', '▁sung', '▁độ', '▁ẩm', '▁cho', '▁da', '▁Hút', '▁tất', '▁cả', '▁bụi', '▁bẩn', '▁,', '▁cặn', '▁dơ', '▁của', '▁lớp', '▁make', '-', 'up', '▁mà', '▁không', '▁gây', '▁khô', '▁da', '▁.', '▁Với', '▁công', '▁nghệ', '▁mới', '▁,', '▁mang', '▁đến', '▁các', '▁tẩy', '▁trang', '▁,', '▁làm', '▁sạch', '▁,', '▁giữ', '▁ẩm', '▁và', '▁dưỡng', '▁mềm', '▁da', '▁đồng', '▁thời', '▁chỉ', '▁trong', '▁một', '▁sản', '▁phẩm', '▁.', '▁Mình', '▁luôn', '▁ưu', '▁tiên', '▁thanh', '▁toán', '▁qua', '▁Sh', 'opee', 'Pay', '▁để', '▁thanh', '▁toán', '▁được', '▁tiện', '▁lợi', '▁và', '▁nhanh', '▁chóng', '&lt;/s&gt;']

--- Results from tokenizer.decode --- 
&lt;s&gt; ▁owned ▁- ▁# ▁Sh opee Pay ch am gu ib ai SS 3 ▁# ▁Sh opee Pay 11 11 ▁link ▁: ▁htt ps : / / bit. ly / U u D ai Sh opee Pay 11 -11 ▁Us ern ame ▁: ▁chip heo 230 6 ▁Thương ▁hiệu ▁l &lt;unk&gt; oreal ▁rất ▁hay ▁chạy ▁sale ▁những ▁ngày ▁lễ ▁lớn ▁và ▁nhất ▁ngày ▁11.11 ▁có ▁thể ▁sẽ ▁có ▁voucher ▁giảm ▁50 ▁% ▁giảm ▁tối ▁đa ▁100 ▁k ▁nếu ▁săn ▁được ▁voucher ▁mình ▁rất ▁muốn ▁sản ▁phẩm ▁ &lt;unk&gt; ▁Nước ▁tẩy ▁trang ▁cho ▁mọi ▁loại ▁da ▁L'O real ▁Paris ▁3 ▁in 1 ▁Mic ellar ▁Water ▁400 ▁ml ▁bởi ▁sản ▁phẩm ▁giá ▁thành ▁bình ▁dân ▁nếu ▁săn ▁sale ▁nữa ▁thì ▁càng ▁rẻ ▁cho ▁dung ▁tích ▁lớn ▁400 ▁ml ▁lận ▁và ▁sản ▁phẩm ▁có ▁chứa ▁công ▁nghệ ▁mi - x en ▁đột ▁phá ▁Chiết ▁xuất ▁thảo ▁dược ▁và ▁Gly cer in ▁bổ ▁sung ▁độ ▁ẩm ▁cho ▁da ▁Hút ▁tất ▁cả ▁bụi ▁bẩn ▁, ▁cặn ▁dơ ▁của ▁lớp ▁make - up ▁mà ▁không ▁gây ▁khô ▁da ▁. ▁Với ▁công ▁nghệ ▁mới ▁, ▁mang ▁đến ▁các ▁tẩy ▁trang ▁, ▁làm ▁sạch ▁, ▁giữ ▁ẩm ▁và ▁dưỡng ▁mềm ▁da ▁đồng ▁thời ▁chỉ ▁trong ▁một ▁sản ▁phẩm ▁. ▁Mình ▁luôn ▁ưu ▁tiên ▁thanh ▁toán ▁qua ▁Sh opee Pay ▁để ▁thanh ▁toán ▁được ▁tiện ▁lợi ▁và ▁nhanh ▁chóng &lt;/s&gt;
</code></pre>
</div>
</div>
</section>
<section id="model-experiment-envibert-single-head-classification" class="level1">
<h1>Model Experiment: EnviBert Single-Head Classification</h1>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> that_nlp_library.models.roberta.classifiers <span class="im">import</span> <span class="op">*</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> that_nlp_library.model_main <span class="im">import</span> <span class="op">*</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> f1_score, accuracy_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>comet_ml is installed but `COMET_API_KEY` is not set.</code></pre>
</div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#This will specify a (or a list) of GPUs for training</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'CUDA_VISIBLE_DEVICES'</span>] <span class="op">=</span> <span class="st">'0'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="train-envibert-using-tdm" class="level2">
<h2 class="anchored" data-anchor-id="train-envibert-using-tdm">Train EnviBert using TDM</h2>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tdm.label_lists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[['Buyer complained seller',
  'Commercial',
  'Delivery',
  'Feature',
  'Order/Item',
  'Others',
  'Payment',
  'Return/Refund',
  'Services',
  'Shopee account']]</code></pre>
</div>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="bu">len</span>(tdm.label_lists[<span class="dv">0</span>]) <span class="co"># 10</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>num_classes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>10</code></pre>
</div>
</div>
<p>Let’s define our model and model controller. First, we will initialize the pretrained <code>body</code> model</p>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers.models.roberta.modeling_roberta <span class="im">import</span> RobertaModel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model_name<span class="op">=</span><span class="st">'nguyenvulebinh/envibert'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>envibert_body <span class="op">=</span> RobertaModel.from_pretrained(model_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of the model checkpoint at nguyenvulebinh/envibert were not used when initializing RobertaModel: ['lm_head.dense.weight', 'lm_head.dense.bias', 'lm_head.bias', 'lm_head.layer_norm.weight', 'lm_head.layer_norm.bias']
- This IS expected if you are initializing RobertaModel from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing RobertaModel from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).</code></pre>
</div>
</div>
<p>Then we can define a simple class as the head for our classification task, something like this:</p>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpleClassificationHead(torch.nn.Module):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                 config, <span class="co"># HuggingFace model configuration</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                 classifier_dropout<span class="op">=</span><span class="fl">0.1</span>, <span class="co"># Dropout ratio (for dropout layer right before the last nn.Linear)</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                 num_labels<span class="op">=</span><span class="va">None</span>, <span class="co"># Number of label output. Every classification class must have this exact variable</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> torch.nn.Dropout(classifier_dropout)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_proj <span class="op">=</span> torch.nn.Linear(config.hidden_size, num_labels)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inp, <span class="op">**</span>kwargs):</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> inp</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(x)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.out_proj(x)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>_model_kwargs<span class="op">=</span>{</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># overall model hyperparams</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multilabel'</span>:tdm.is_multilabel, <span class="co"># False</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multihead'</span>:tdm.is_multihead, <span class="co"># False</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class_sizes'</span>:num_classes,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class'</span>: SimpleClassificationHead,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># classfication head hyperparams</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'classifier_dropout'</span>:<span class="fl">0.1</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_init_classification(model_class <span class="op">=</span> RobertaBaseForSequenceClassification,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>                                  cpoint_path <span class="op">=</span> <span class="st">'nguyenvulebinh/envibert'</span>, </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>                                  output_hidden_states<span class="op">=</span><span class="va">False</span>, <span class="co"># since we are not using 'hidden layer contatenation' technique</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                                  seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                                  body_model<span class="op">=</span>envibert_body,</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                                  model_kwargs <span class="op">=</span> _model_kwargs)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>metric_funcs <span class="op">=</span> [partial(f1_score,average<span class="op">=</span><span class="st">'macro'</span>),accuracy_score] <span class="co"># we will use both f1_macro and accuracy score as metrics</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>controller <span class="op">=</span> ModelController(model,tdm,metric_funcs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading body weights. This assumes the body is the very first first-layer block of your custom architecture</code></pre>
</div>
</div>
<p>And we can start training our model</p>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">8e-5</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>bs<span class="op">=</span><span class="dv">4</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>wd<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>epochs<span class="op">=</span> <span class="dv">2</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>controller.fit(epochs,lr,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>               batch_size<span class="op">=</span>bs,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>               weight_decay<span class="op">=</span>wd,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>               save_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>               compute_metrics<span class="op">=</span>compute_metrics_classification,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/quan/anaconda3/envs/fastai_v2/lib/python3.10/site-packages/transformers/optimization.py:391: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use the PyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>

    <div>
      
      <progress value="1194" max="1194" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [1194/1194 01:04, Epoch 1/2]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">F1 Score L1</th>
<th data-quarto-table-cell-role="th">Accuracy Score L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>No log</td>
<td>1.059704</td>
<td>0.350748</td>
<td>0.677852</td>
</tr>
<tr class="even">
<td>1</td>
<td>No log</td>
<td>1.007712</td>
<td>0.462641</td>
<td>0.697987</td>
</tr>
</tbody>
</table>
<p>
</p></div>
</div>
</div>
<section id="logging-your-training" class="level3">
<h3 class="anchored" data-anchor-id="logging-your-training">Logging your training</h3>
<p>You can log your training using HuggingFace:</p>
<ul>
<li><p>Supported platforms are “azure_ml”, “comet_ml”, “mlflow”, “neptune”, “tensorboard”,“clearml” and “wandb”</p></li>
<li><p>References:</p>
<ul>
<li><p>https://huggingface.co/docs/transformers/v4.28.0/en/main_classes/trainer#transformers.TrainingArguments</p></li>
<li><p>https://docs.wandb.ai/guides/integrations/huggingface#:~:text=Logging%20your%20Hugging%20Face%20model,every%20save_steps%20in%20the%20TrainingArguments%20.</p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>controller.fit(epochs,lr,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>               batch_size<span class="op">=</span>bs,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>               weight_decay<span class="op">=</span>wd,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>               save_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>               compute_metrics<span class="op">=</span>compute_metrics_classification,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>               hf_report_to<span class="op">=</span><span class="st">'wandb'</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can save your model weights at the end of your training</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>controller.trainer.model.save_pretrained(<span class="st">'./sample_weights/model_progress'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or you can save your weights at every epochs during your training</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>controller.fit(epochs,lr,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>               batch_size<span class="op">=</span>bs,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>               weight_decay<span class="op">=</span>wd,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>               save_checkpoint<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>               o_dir<span class="op">=</span><span class="st">'sample_weights'</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>               compute_metrics<span class="op">=</span>compute_metrics_classification,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="train-envibert-with-tokenized-datasetdict" class="level2">
<h2 class="anchored" data-anchor-id="train-envibert-with-tokenized-datasetdict">Train EnviBert with tokenized DatasetDict</h2>
<p>This part assumes you already have your tokenized datasetdict. You must have your tokenizer as well</p>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>tokenizer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>RobertaTokenizer(name_or_path='', vocab_size=59993, model_max_length=1000000000000000019884624838656, is_fast=False, padding_side='right', truncation_side='right', special_tokens={'bos_token': '&lt;s&gt;', 'eos_token': '&lt;/s&gt;', 'unk_token': '&lt;unk&gt;', 'sep_token': '&lt;/s&gt;', 'pad_token': '&lt;pad&gt;', 'cls_token': '&lt;s&gt;', 'mask_token': '&lt;mask&gt;'}, clean_up_tokenization_spaces=True)</code></pre>
</div>
</div>
<p>Note that your DatasetDict must contain tokens besides raw text (which typically includes ‘input_ids’, ‘token_type_ids’, ‘attention_mask’)</p>
<div id="cell-52" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>main_ddict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 4780
    })
    validation: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 447
    })
})</code></pre>
</div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>model_name<span class="op">=</span><span class="st">'nguyenvulebinh/envibert'</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>_model_kwargs<span class="op">=</span>{</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># overall model hyperparams</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multilabel'</span>:<span class="va">False</span>, <span class="co"># False</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multihead'</span>:<span class="va">False</span>, <span class="co"># False</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class_sizes'</span>:num_classes,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class'</span>: SimpleClassificationHead,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># classfication head hyperparams</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'classifier_dropout'</span>:<span class="fl">0.1</span> </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>envibert_body <span class="op">=</span> RobertaModel.from_pretrained(model_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_init_classification(model_class <span class="op">=</span> RobertaBaseForSequenceClassification,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                                  cpoint_path <span class="op">=</span> <span class="st">'nguyenvulebinh/envibert'</span>, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                                  output_hidden_states<span class="op">=</span><span class="va">False</span>, <span class="co"># since we are not using 'hidden layer contatenation' technique</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                  seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                                  body_model<span class="op">=</span>envibert_body,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                                  model_kwargs <span class="op">=</span> _model_kwargs)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>metric_funcs <span class="op">=</span> [partial(f1_score,average<span class="op">=</span><span class="st">'macro'</span>),accuracy_score] <span class="co"># we will use both f1_macro and accuracy score as metrics</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>controller <span class="op">=</span> ModelController(model,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>                             metric_funcs<span class="op">=</span>metric_funcs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of the model checkpoint at nguyenvulebinh/envibert were not used when initializing RobertaModel: ['lm_head.dense.weight', 'lm_head.dense.bias', 'lm_head.bias', 'lm_head.layer_norm.weight', 'lm_head.layer_norm.bias']
- This IS expected if you are initializing RobertaModel from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing RobertaModel from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading body weights. This assumes the body is the very first first-layer block of your custom architecture</code></pre>
</div>
</div>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">8e-5</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>bs<span class="op">=</span><span class="dv">4</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>wd<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>epochs<span class="op">=</span> <span class="dv">2</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>controller.fit(epochs,lr,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>               ddict<span class="op">=</span>main_ddict, <span class="co"># Put in your tokenized datasetdict here</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>               batch_size<span class="op">=</span>bs,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>               weight_decay<span class="op">=</span>wd,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>               save_checkpoint<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>               compute_metrics<span class="op">=</span>compute_metrics_classification,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>               tokenizer<span class="op">=</span>tokenizer,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>               label_names<span class="op">=</span><span class="st">'L1'</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/quan/anaconda3/envs/fastai_v2/lib/python3.10/site-packages/transformers/optimization.py:391: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use the PyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>

    <div>
      
      <progress value="1194" max="1194" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [1194/1194 01:06, Epoch 1/2]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">F1 Score L1</th>
<th data-quarto-table-cell-role="th">Accuracy Score L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>No log</td>
<td>1.059704</td>
<td>0.350748</td>
<td>0.677852</td>
</tr>
<tr class="even">
<td>1</td>
<td>No log</td>
<td>1.007712</td>
<td>0.462641</td>
<td>0.697987</td>
</tr>
</tbody>
</table>
<p>
</p></div>
</div>
</div>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>controller.trainer.model.save_pretrained(<span class="st">'./sample_weights/model_progress'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-using-trained-model-using-tdm" class="level2">
<h2 class="anchored" data-anchor-id="predict-using-trained-model-using-tdm">Predict using trained model, using TDM</h2>
<section id="load-trained-model" class="level3">
<h3 class="anchored" data-anchor-id="load-trained-model">Load trained model</h3>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>_model_kwargs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'is_multilabel': False,
 'is_multihead': False,
 'head_class_sizes': 10,
 'head_class': __main__.SimpleClassificationHead,
 'classifier_dropout': 0.1}</code></pre>
</div>
</div>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>trained_model <span class="op">=</span> model_init_classification(model_class <span class="op">=</span> RobertaBaseForSequenceClassification,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                                          cpoint_path <span class="op">=</span> Path(<span class="st">'./sample_weights/model_progress'</span>), </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                                          output_hidden_states<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                                          seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                                          model_kwargs <span class="op">=</span> _model_kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of the model checkpoint at sample_weights/model_progress were not used when initializing RobertaBaseForSequenceClassification: ['body_model.pooler.dense.weight', 'body_model.pooler.dense.bias']
- This IS expected if you are initializing RobertaBaseForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing RobertaBaseForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).</code></pre>
</div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>trained_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>RobertaBaseForSequenceClassification(
  (body_model): RobertaModel(
    (embeddings): RobertaEmbeddings(
      (word_embeddings): Embedding(59993, 768, padding_idx=1)
      (position_embeddings): Embedding(514, 768, padding_idx=1)
      (token_type_embeddings): Embedding(1, 768)
      (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
      (dropout): Dropout(p=0.1, inplace=False)
    )
    (encoder): RobertaEncoder(
      (layer): ModuleList(
        (0-5): 6 x RobertaLayer(
          (attention): RobertaAttention(
            (self): RobertaSelfAttention(
              (query): Linear(in_features=768, out_features=768, bias=True)
              (key): Linear(in_features=768, out_features=768, bias=True)
              (value): Linear(in_features=768, out_features=768, bias=True)
              (dropout): Dropout(p=0.1, inplace=False)
            )
            (output): RobertaSelfOutput(
              (dense): Linear(in_features=768, out_features=768, bias=True)
              (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
              (dropout): Dropout(p=0.1, inplace=False)
            )
          )
          (intermediate): RobertaIntermediate(
            (dense): Linear(in_features=768, out_features=1024, bias=True)
            (intermediate_act_fn): GELUActivation()
          )
          (output): RobertaOutput(
            (dense): Linear(in_features=1024, out_features=768, bias=True)
            (LayerNorm): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
            (dropout): Dropout(p=0.1, inplace=False)
          )
        )
      )
    )
  )
  (classification_head): SimpleClassificationHead(
    (dropout): Dropout(p=0.1, inplace=False)
    (out_proj): Linear(in_features=768, out_features=10, bias=True)
  )
)</code></pre>
</div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>metric_funcs <span class="op">=</span> [partial(f1_score,average<span class="op">=</span><span class="st">'macro'</span>),accuracy_score] <span class="co"># we will use both f1_macro and accuracy score as metrics</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>controller <span class="op">=</span> ModelController(trained_model,tdm,metric_funcs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-trainvalidation-set" class="level3">
<h3 class="anchored" data-anchor-id="predict-trainvalidation-set">Predict Train/Validation set</h3>
<p>Make prediction on all validation set</p>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> controller.predict_ddict(ds_type<span class="op">=</span><span class="st">'validation'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Start making predictions --------------------</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>df_val.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - Chơi gam rất là lác</td>
<td>3</td>
<td>google play</td>
<td>Commercial</td>
<td>0.837496</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>google play - Zq</td>
<td>5</td>
<td>google play</td>
<td>Others</td>
<td>0.927602</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>non owned - Làn sóng kỹ thuật số và sự lựa chọ...</td>
<td>5</td>
<td>non owned</td>
<td>Others</td>
<td>0.918241</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>google play - Hàng quốc tế không còn ship COD ...</td>
<td>6</td>
<td>google play</td>
<td>Delivery</td>
<td>0.804539</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>google play - Quá tệ . Giao hàng chậm như rùa ...</td>
<td>2</td>
<td>google play</td>
<td>Delivery</td>
<td>0.758327</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>To convert the label index to string, we can use the <code>label_lists</code> attribute of tdm</p>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df_val[<span class="st">'label'</span>]<span class="op">=</span> df_val[<span class="st">'label'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: tdm.label_lists[<span class="dv">0</span>][x]).values</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>df_val.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - Chơi gam rất là lác</td>
<td>Feature</td>
<td>google play</td>
<td>Commercial</td>
<td>0.837496</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>google play - Zq</td>
<td>Others</td>
<td>google play</td>
<td>Others</td>
<td>0.927602</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>non owned - Làn sóng kỹ thuật số và sự lựa chọ...</td>
<td>Others</td>
<td>non owned</td>
<td>Others</td>
<td>0.918241</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>google play - Hàng quốc tế không còn ship COD ...</td>
<td>Payment</td>
<td>google play</td>
<td>Delivery</td>
<td>0.804539</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>google play - Quá tệ . Giao hàng chậm như rùa ...</td>
<td>Delivery</td>
<td>google play</td>
<td>Delivery</td>
<td>0.758327</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>You can try to get your metric to see if it matches your last traing epoch’s above</p>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>f1_score(df_val.label,df_val.pred_L1,average<span class="op">=</span><span class="st">'macro'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.4634417008698494</code></pre>
</div>
</div>
<p>You can also make predictions on all training set, by changing argument <code>ds_type</code> to “train”</p>
</section>
<section id="predict-test-set" class="level3">
<h3 class="anchored" data-anchor-id="predict-test-set">Predict Test set</h3>
<p>We will go through details on how to make a prediction on a completely new and raw dataset using our trained model. For now, let’s reuse the sample csv and pretend it’s our test set</p>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> TextDataMain.from_csv(Path(<span class="st">'sample_data'</span>)<span class="op">/</span><span class="st">'sample_large.csv'</span>,return_df<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>----- Input Validation Precheck -----
DataFrame contains duplicated values!
-----&gt; Number of duplications: 16 rows</code></pre>
</div>
</div>
<p>We will remove all the labels and unnecessary columns</p>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>true_label <span class="op">=</span> df_test[<span class="st">'L1'</span>].values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df_test.drop([<span class="st">'L1'</span>,<span class="st">'L2'</span>],axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>df_test.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">Content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Google Play</td>
<td>App ncc lúc nào cx lag đơ, phần tìm kiếm thì v...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Non Owned</td>
<td>..❗️ GÓC THANH LÝ Tính ra rẻ hơn cả mua #Shope...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Google Play</td>
<td>Mắc gì người ta đặt hàng toàn lỗi 😃????</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Owned</td>
<td>#GhienShopeePayawardT8 Khi bạn chơi shopee quá...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Google Play</td>
<td>Rất bức xúc khi dùng . mã giảm giá người dùng ...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We will create a DatasetDict for this test dataframe</p>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>test_ddict <span class="op">=</span> tdm.get_test_datasetdict_from_df(df_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Getting Test Set --------------------
----- Input Validation Precheck -----
DataFrame contains duplicated values!
-----&gt; Number of duplications: 19 rows
-------------------- Start Test Set Transformation --------------------
----- Metadata Simple Processing &amp; Concatenating to Main Content -----
-------------------- Text Transformation --------------------
----- text_normalize -----
-------------------- Test Leak Checking --------------------
- Before leak check
Size: 2269
- After leak check
Size: 0
- Number of rows leaked: 2269, or 100.00% of the original validation (or test) data
-------------------- Construct DatasetDict --------------------</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|█████████████████████████████████████| 2269/2269 [00:00&lt;00:00, 3954.30it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>Remember the <strong><em>Leak Check</em></strong> we did in TextDataMain? Our <code>df_test</code> only has 70 rows, and it also shows that 70 rows of our data is leaked (100%), which is correct because this test dataset is actually a small sample of the training data.</p>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>test_ddict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DatasetDict({
    test: Dataset({
        features: ['text', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 2269
    })
})</code></pre>
</div>
</div>
<p>Our test data has been processed + transformed (but not augmented) the same way as the validation set. Now we can start making the prediction</p>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>controller <span class="op">=</span> ModelController(trained_model,tdm)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>df_result <span class="op">=</span> controller.predict_ddict(ddict<span class="op">=</span>test_ddict,ds_type<span class="op">=</span><span class="st">'test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Start making predictions --------------------</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-87" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df_result.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - App ncc lúc nào cx lag đơ , phần...</td>
<td>google play</td>
<td>Feature</td>
<td>0.878221</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>non owned - .. ❗ ️ GÓC THANH LÝ Tính ra rẻ hơn...</td>
<td>non owned</td>
<td>Others</td>
<td>0.930981</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>google play - Mắc gì người ta đặt hàng toàn lỗ...</td>
<td>google play</td>
<td>Feature</td>
<td>0.849374</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>owned - # GhienShopeePayawardT8 Khi bạn chơi s...</td>
<td>owned</td>
<td>Commercial</td>
<td>0.915552</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>google play - Rất bức xúc khi dùng . mã giảm g...</td>
<td>google play</td>
<td>Shopee account</td>
<td>0.571471</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Let’s quickly check the f1 score to make sure everything works correctly</p>
<div id="cell-89" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>f1_score(true_label,df_result.pred_L1,average<span class="op">=</span><span class="st">'macro'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0.5303012712104336</code></pre>
</div>
</div>
<p>Since we are getting the predictions on the entire training+validation set, the F1 score is expected to be slightly higher than validation’s F1 score.</p>
<p>We can even predict top k results</p>
<div id="cell-92" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>df_result <span class="op">=</span> controller.predict_ddict(ddict<span class="op">=</span>test_ddict,ds_type<span class="op">=</span><span class="st">'test'</span>,topk<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>df_result.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Start making predictions --------------------</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
<th data-quarto-table-cell-role="th">pred_L1_top1</th>
<th data-quarto-table-cell-role="th">pred_L1_top2</th>
<th data-quarto-table-cell-role="th">pred_L1_top3</th>
<th data-quarto-table-cell-role="th">pred_prob_L1_top1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1_top2</th>
<th data-quarto-table-cell-role="th">pred_prob_L1_top3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - App ncc lúc nào cx lag đơ , phần...</td>
<td>google play</td>
<td>[3, 5, 9]</td>
<td>[0.87822074, 0.023822138, 0.02159522]</td>
<td>Feature</td>
<td>Others</td>
<td>Shopee account</td>
<td>0.878221</td>
<td>0.023822</td>
<td>0.021595</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>non owned - .. ❗ ️ GÓC THANH LÝ Tính ra rẻ hơn...</td>
<td>non owned</td>
<td>[5, 1, 0]</td>
<td>[0.9309808, 0.015578598, 0.009805982]</td>
<td>Others</td>
<td>Commercial</td>
<td>Buyer complained seller</td>
<td>0.930981</td>
<td>0.015579</td>
<td>0.009806</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>google play - Mắc gì người ta đặt hàng toàn lỗ...</td>
<td>google play</td>
<td>[3, 5, 9]</td>
<td>[0.8493735, 0.050054528, 0.021759989]</td>
<td>Feature</td>
<td>Others</td>
<td>Shopee account</td>
<td>0.849374</td>
<td>0.050055</td>
<td>0.021760</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>owned - # GhienShopeePayawardT8 Khi bạn chơi s...</td>
<td>owned</td>
<td>[1, 6, 7]</td>
<td>[0.9155516, 0.01255093, 0.010521941]</td>
<td>Commercial</td>
<td>Payment</td>
<td>Return/Refund</td>
<td>0.915552</td>
<td>0.012551</td>
<td>0.010522</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>google play - Rất bức xúc khi dùng . mã giảm g...</td>
<td>google play</td>
<td>[9, 3, 1]</td>
<td>[0.57147133, 0.25687057, 0.03061041]</td>
<td>Shopee account</td>
<td>Feature</td>
<td>Commercial</td>
<td>0.571471</td>
<td>0.256871</td>
<td>0.030610</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>If we just want to make a prediction on a small amount of data (single sentence, or a few sentences), we can use <a href="https://anhquan0412.github.io/that-nlp-library/model_main.html#modelcontroller.predict_raw_text"><code>ModelController.predict_raw_text</code></a></p>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Since we have some metadatas, we need to define a dictionary (to imitate a DatasetDict)</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>raw_content<span class="op">=</span>{</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Source'</span>: <span class="st">'Google play'</span>,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Content'</span>:<span class="st">'Tôi không thích Shopee.Tại vì dùng app rất chậm,lag banh nhà lầu, thậm chí log in còn không đc'</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we don’t use metadata, we can use something like this:</p>
<p><code>raw_content='Tôi không thích Shopee.Tại vì dùng app rất chậm,lag banh nhà lầu, thậm chí log in còn không đc'</code></p>
<div id="cell-96" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>df_result <span class="op">=</span> controller.predict_raw_text(raw_content,topk<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>df_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|███████████████████████████████████████████| 1/1 [00:00&lt;00:00, 4718.00it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - Tôi không thích Shopee . Tại vì ...</td>
<td>google play</td>
<td>Feature</td>
<td>0.876843</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
</section>
<section id="predict-using-trained-model-using-tokenized-datasetdict" class="level2">
<h2 class="anchored" data-anchor-id="predict-using-trained-model-using-tokenized-datasetdict">Predict using trained model, using tokenized DatasetDict</h2>
<section id="load-trained-model-1" class="level3">
<h3 class="anchored" data-anchor-id="load-trained-model-1">Load trained model</h3>
<div id="cell-99" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>model_name<span class="op">=</span><span class="st">'nguyenvulebinh/envibert'</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>_model_kwargs<span class="op">=</span>{</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># overall model hyperparams</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multilabel'</span>:<span class="va">False</span>, <span class="co"># False</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_multihead'</span>:<span class="va">False</span>, <span class="co"># False</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class_sizes'</span>:num_classes,</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'head_class'</span>: SimpleClassificationHead,</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># classfication head hyperparams</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'classifier_dropout'</span>:<span class="fl">0.1</span> </span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-100" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>trained_model <span class="op">=</span> model_init_classification(model_class <span class="op">=</span> RobertaBaseForSequenceClassification,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                                          cpoint_path <span class="op">=</span> Path(<span class="st">'./sample_weights/model_progress'</span>), </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                                          output_hidden_states<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                                          seed<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                                          model_kwargs <span class="op">=</span> _model_kwargs)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>metric_funcs <span class="op">=</span> [partial(f1_score,average<span class="op">=</span><span class="st">'macro'</span>),accuracy_score]</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>controller <span class="op">=</span> ModelController(trained_model,metric_funcs) <span class="co"># notice that we don't use tdm here</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some weights of the model checkpoint at sample_weights/model_progress were not used when initializing RobertaBaseForSequenceClassification: ['body_model.pooler.dense.weight', 'body_model.pooler.dense.bias']
- This IS expected if you are initializing RobertaBaseForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
- This IS NOT expected if you are initializing RobertaBaseForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).</code></pre>
</div>
</div>
</section>
<section id="predict-validation-set" class="level3">
<h3 class="anchored" data-anchor-id="predict-validation-set">Predict validation set</h3>
<div id="cell-102" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>main_ddict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DatasetDict({
    train: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 4780
    })
    validation: Dataset({
        features: ['text', 'label', 'Source', 'input_ids', 'token_type_ids', 'attention_mask', 'pred_L1', 'pred_prob_L1'],
        num_rows: 447
    })
})</code></pre>
</div>
</div>
<div id="cell-103" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>my_label_name <span class="op">=</span> <span class="st">'L1'</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>my_class_predefined <span class="op">=</span> [<span class="st">'Buyer complained seller'</span>,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'Commercial'</span>,</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a> <span class="st">'Delivery'</span>,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a> <span class="st">'Feature'</span>,</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a> <span class="st">'Order/Item'</span>,</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a> <span class="st">'Others'</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a> <span class="st">'Payment'</span>,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a> <span class="st">'Return/Refund'</span>,</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a> <span class="st">'Services'</span>,</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a> <span class="st">'Shopee account'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-104" class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> controller.predict_ddict(main_ddict,</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>                                  ds_type<span class="op">=</span><span class="st">'validation'</span>,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>                                  is_multilabel<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                                  tokenizer<span class="op">=</span>tokenizer,</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>                                  label_names <span class="op">=</span> my_label_name,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>                                  class_names_predefined<span class="op">=</span>my_class_predefined</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>                                  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-------------------- Start making predictions --------------------</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="cell-105" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>df_val.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">Source</th>
<th data-quarto-table-cell-role="th">pred_L1</th>
<th data-quarto-table-cell-role="th">pred_prob_L1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google play - Chơi gam rất là lác</td>
<td>3</td>
<td>google play</td>
<td>Commercial</td>
<td>0.837496</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>google play - Zq</td>
<td>5</td>
<td>google play</td>
<td>Others</td>
<td>0.927602</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>non owned - Làn sóng kỹ thuật số và sự lựa chọ...</td>
<td>5</td>
<td>non owned</td>
<td>Others</td>
<td>0.918241</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>google play - Hàng quốc tế không còn ship COD ...</td>
<td>6</td>
<td>google play</td>
<td>Delivery</td>
<td>0.804539</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>google play - Quá tệ . Giao hàng chậm như rùa ...</td>
<td>2</td>
<td>google play</td>
<td>Delivery</td>
<td>0.758327</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</section>
<section id="predict-test-set-1" class="level3">
<h3 class="anchored" data-anchor-id="predict-test-set-1">Predict test set</h3>
<div id="cell-107" class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>test_ddict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DatasetDict({
    test: Dataset({
        features: ['text', 'Source', 'input_ids', 'token_type_ids', 'attention_mask', 'pred_L1', 'pred_prob_L1'],
        num_rows: 2269
    })
})</code></pre>
</div>
</div>
<p>It would be cumbersome to preprocess your test data the same way you preprocess your validation set, without the use of tdm (which stores the preprocess pipeline). In short, you need to produce the test datasetdict <code>test_ddict</code> containing processed <code>'input_ids', 'token_type_ids', 'attention_mask'</code>, then call</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>df_results <span class="op">=</span> controller.predict_ddict(ddict<span class="op">=</span>test_ddict,</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>                                      ds_type<span class="op">=</span><span class="st">'test'</span>,</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>                                      is_multilabel<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>                                      tokenizer<span class="op">=</span>tokenizer,</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>                                      label_names <span class="op">=</span> my_label_name,</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>                                      class_names_predefined<span class="op">=</span>my_class_predefined     </span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>                                     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>
</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/anhquan0412\.github\.io\/that-nlp-library");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/anhquan0412/that-nlp-library/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>